<html>
<head>
  <meta content="text/html; charset=UTF-8"></meta>
  <meta charset="utf-8"></meta>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" id="icon_stylesheet">

  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" id="theme_stylesheet">
  <link href="https://cdn.jsdelivr.net/foundation/6.2.1/foundation.min.css" rel="stylesheet" id="theme_stylesheet">
  <style>[class*="foundicon-"] {font-family: GeneralFoundicons;font-style: normal;}</style>
  <title>Интерфейс переводчика</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/jdorn/json-editor/master/dist/jsoneditor.min.js"></script>
  <script src="editor_api.js"></script>
  <script src="filemanager.js"></script>
  <script type="text/javascript">
    JSONEditor.defaults.options.theme = 'bootstrap3';
    JSONEditor.defaults.options.disable_array_delete_all_rows = true;
    JSONEditor.defaults.options.disable_array_delete_last_row = true;
    JSONEditor.defaults.options.disable_array_reorder = true;
    JSONEditor.defaults.options.disable_properties = true;
    JSONEditor.defaults.options.disable_edit_json = true;
    JSONEditor.defaults.options.object_layout = 'grid';

    function backtofm()
    {
      editor_holder = document.getElementById("editor-holder")
      $("#editor-holder").slideUp()
      $("#editor-navigation").slideUp()
      $("#file-browser").slideDown()
      $("#fmnavigation").slideDown()
      reset(editor)
    }

    function get_call_arguments()
    {
      var params = location.search.slice(1).split('&')
      var pairs = {}
      $.each(params, function(i, d)
        {
          r = d.split('=')
          pairs[r[0]] = r[1]
        })
      return pairs
    }

    function unlogin(){
        var date = new Date();
        date.setDate(date.getDate - 1)
        document.cookie = "sbtghsword=;expires=" + date.toUTCString()
        document.cookie = "sbtghuser=;expires=" + date.toUTCString()
      }

    function check_authdata()
    {
      unlogin()
      document.getElementById('authorized').style.display = ''
      $.ajax({
        url: "https://api.github.com/user",
        type: 'GET',
        beforeSend: function (xhr) {
          xhr.setRequestHeader ("Authorization", "Basic " +
            btoa(authdata.uname + ":" + authdata.upass));
        },
        data: {},
        success: function(user_data)
        {
          authdata.email = user_data.email
          var date = new Date()
          date.setDate(date.getDate + 365)
          document.cookie = "sbtghuser=" + authdata.uname +
            ";domain=" + document.domain + ";expires="+ date.toUTCString()
          document.cookie = "sbtghsword=" + authdata.upass +
            ";domain=" + document.domain + ";expires="+ date.toUTCString()
          show_authdata(user_data)
        }
      })
    }

    function show_authdata(udata)
    {
      var authinfo = document.getElementById('authorized')
      authinfo.style.display = ''
      authinfo.innerHTML = "Авторизирован как:"
      var link = document.createElement('a')
      link.setAttribute('href', 'https://github.com/' + authdata.uname)
      link.innerHTML = udata.login
      var idiv = document.createElement('div')
      var img = document.createElement('img')
      img.setAttribute('src', udata.avatar_url)
      img.className = 'img-responsive img-rounded'
      var ebutdiv = document.createElement('div')
      var ldiv = document.createElement('div')
      var exitbutton = document.createElement('button')
      exitbutton.className = "btn btn-default"
      exitbutton.setAttribute('type', 'button')
      exitbutton.innerHTML = "Выйти"
      exitbutton.title = "Выйти"
      exitbutton.onclick = function() {unlogin(); location.reload()}
      idiv.appendChild(img)
      ldiv.appendChild(link)
      ebutdiv.appendChild(exitbutton)
      authinfo.appendChild(ldiv)
      authinfo.appendChild(idiv)
      authinfo.appendChild(ebutdiv)
    }

    function getCookie(name) {
      var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
      ));
      return matches ? decodeURIComponent(matches[1]) : "";
    }

    function login()
    {
      var data = $('#auth-form').serializeArray().reduce(
        function(obj, item) {
          obj[item.name] = item.value;
          return obj;
        }, {});
      authdata = data
      check_authdata()
      $('#auth-form').slideUp()
      $('#authorized').slideDown()
    }

    function get_authdata()
    {
      var uname = getCookie('sbtghuser')
      if (uname.length == 0)
      { return false }
      var upass = getCookie('sbtghsword')
      return {uname : uname, upass: upass}
    }
  </script>
</head>
<body>
  <table style="height:100%;">
  <tbody>
  <tr heigth="20%">
  <h1>Интерфейс переводчика</h1>
  </tr>
  <tr valign="top" >
  <td width="20%">

  <div id="navigation"  width="20%" style="position: fixed">
  <div id="fmnavigation" width="20%">
    <button class="btn btn-default" id="login-button" style="display:none"
      type="button">Войти</button>
    <button class="btn btn-default" onclick="backtofm();goto_home(on_file)"
      type="button">Домой</button>
  </div>
  <div id="editor-navigation"  style="display: none">
    <button class="btn btn-default" onclick="commit()" type="button">Сохранить</button>
    <button class="btn btn-default" onclick="backtofm();" type="button">Назад</button>
  </div>

  <button class="btn btn-default"
      onclick="$('html, body').stop().animate({scrollTop: 0}, 1000)"
      type="button">Наверх</button>

  <div id='authorized' style='display: none'>Авторизация не удалась!
  <div><button class="btn btn-default" type="button"
    onclick="$('#authorized').slideUp(); $('#auth-form').slideDown()">
    Попробовать снова</button></div></div>
  <form id="auth-form" style="display: none">
    Имя пользователя:
    <input type='text' name='uname'>
    Пароль:
    <input type='password' name='upass'>
    <button class="btn btn-default" onclick="login()" type="button">Вход</button>
  </form>

  </div>

  </td>
  <td>
  <div id="file-browser">
  </div>
  <div id="editor-holder" style="display: none">
  </div>
  </td>
  </tr>
  </tbody>
  </table>

  <script type="text/javascript">
    // Initialization
    editor_holder = document.getElementById("editor-holder")
    editor = make_editor(editor_holder)

    prepare_fm(document.getElementById("file-browser"))

    var authdata = get_authdata()
    if (authdata == false)
    {
      document.getElementById('auth-form').style.display = ''
    }
    else
    {
      check_authdata()
    }

    var args = get_call_arguments()
    if (!args.code)
    {
      var authbutton = document.getElementById("login-button")
      //authbutton.style.display = ""//Will be commented until oauth wont be implemented
      var state = Math.random().toString(36).substring(7);
      var href_part = "https://github.com/login/oauth/authorize?" +
          "client_id=9e609aef5d6e71a4ed63&" +
          "redirect_url=\\\"https://sbt-community.github.io/\\\"&" +
          "state=" + state
      authbutton.onclick = function(){
        location.href = href_part
      }
    }
    else
    {
      alert("Autorization token received but no client secret provided."+
        "It's not your fault, just a signal about forbidden type of authorization." +
        "Actually you shouldn't see that message. Do you used some hackery?")
    }


    function commit()
    {
      var content = JSON.stringify(get_json(editor))
      console.log(content)
      console.log(editor.filedata)

      jQuery.ajax({
        url: editor.filedata.url.split('?')[0],
        type: 'PUT',
        contentType: 'application/json',
        beforeSend: function (xhr) {
          xhr.setRequestHeader ("Authorization", "Basic " +
            btoa(authdata.uname + ":" + authdata.upass));
        },
        data: JSON.stringify({
          message: "Test commit from web-interface",
          path: editor.filedata.path,
          content: btoa(escape(content)),
          sha: editor.filedata.sha,
          branch: "web-interface-tests",
          author: {name: authdata.uname, email: authdata.email},
          committer: {name: authdata.uname, email: authdata.email},
        }),
        success: function(d, s, r)
        {
          console.log(d)
          console.log(s)
          alert("Commit pushed successfully!")
        }
    })
    }

    function on_file(json)
    {
      $("#editor-holder").slideDown()
      $("#file-browser").slideUp()
      $("#editor-navigation").slideDown()
      $("#fmnavigation").slideUp()
      console.log(json.download_url)
      load_json(editor, json.download_url)
      editor.filedata = json
    }
    goto_home(on_file)

  </script>
</body>
</html>