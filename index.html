<!DOCTYPE html>
<html>
<head>
  <meta content="text/html; charset=UTF-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8"></meta>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" id="icon_stylesheet">
  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" id="theme_stylesheet">
  <title>Интерфейс переводчика</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script type="text/javascript" src="https://rawgit.com/jdorn/json-editor/master/dist/jsoneditor.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://rawgit.com/dankogai/js-base64/master/base64.min.js"></script>
  <script src="githubapi.js"></script>
  <script src="editor_api.js"></script>
  <script src="filemanager.js"></script>
  <script src="worker_manager.js"></script>
  <style>
  #sidebar.affix{
    width: 12%;
    top: 90px;
  }
  #topnav.affix {
    top: 0;
    width: 100%;
    height: 70px;
  }
  .affix + .container-fluid {
    padding-top: 70px;
  }
  .navbar{
    z-index: 2;
    height: 70px;
  }
  </style>
  <script type="text/javascript">
    JSONEditor.defaults.options.theme = 'bootstrap3';
    JSONEditor.defaults.options.iconlib = "bootstrap3";
    JSONEditor.defaults.options.disable_array_delete_all_rows = true;
    JSONEditor.defaults.options.disable_array_delete_last_row = true;
    JSONEditor.defaults.options.disable_array_reorder = true;
    JSONEditor.defaults.options.disable_properties = true;
    JSONEditor.defaults.options.disable_edit_json = true;
    JSONEditor.defaults.options.object_layout = 'grid';

    function backtofm(editor)
    {
      if (editor.touched)
      {
        var newdata = JSON.stringify(editor.get_json(), null, 2)
        var olddata = Base64.decode(editor.filedata.content)
        if (newdata != olddata)
        {
          $('#unsavedMessage').modal()
          return
        }
      }
      $("#editor-holder").slideUp()
      $("#editor-navigation").slideUp()
      $("#file-browser").slideDown()
      $("#fmnavigation").slideDown()
      editor.reset()
    }

    function get_call_arguments()
    {
      var params = location.search.slice(1).split('&')
      var pairs = {}
      $.each(params, function(i, d)
        {
          r = d.split('=')
          pairs[r[0]] = r[1]
        })
      return pairs
    }

    function unlogin(){
      document.getElementById('authorized').style.display = ''
      var date = new Date();
      document.cookie = "sbtghsword=;expires=" + date.toUTCString() +
        ";domain=" + document.domain
      document.cookie = "sbtghuser=;expires=" + date.toUTCString() +
        ";domain=" + document.domain
    }

    function show_userdata(authdata, udata)
    {
      var authinfo = document.getElementById('authorized')
      authinfo.style.display = ''
      authinfo.innerHTML = "Авторизирован как:"
      var link = document.createElement('a')
      link.setAttribute('href', 'https://github.com/' + authdata.uname)
      link.innerHTML = udata.login
      var idiv = document.createElement('div')
      idiv.style.width='inherit'
      var img = document.createElement('img')
      img.setAttribute('src', udata.avatar_url)
      img.className = 'img-responsive img-rounded'
      var ebutdiv = document.createElement('div')
      var ldiv = document.createElement('div')
      var exitbutton = document.createElement('button')
      exitbutton.className = "btn btn-default"
      exitbutton.setAttribute('type', 'button')
      exitbutton.innerHTML = "Выйти"
      exitbutton.title = "Выйти"
      exitbutton.onclick = function() {unlogin(); location.reload()}
      idiv.appendChild(img)
      ldiv.appendChild(link)
      ebutdiv.appendChild(exitbutton)
      authinfo.appendChild(ldiv)
      authinfo.appendChild(idiv)
      authinfo.appendChild(ebutdiv)
      $('#loginRequiredAlert').slideUp()
      $('#commitButton').addClass('btn-success')
      $('#commitButton')[0].onclick = null
      $('#commitButton').attr('data-target', '#commitMessage')
      $('#commitButton').attr('data-toggle', 'modal')
    }

    function getCookie(name) {
      var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
      ));
      return matches ? decodeURIComponent(matches[1]) : "";
    }

    function login(account, data)
    {
      unlogin()
      account.check_authdata(data, function(user_data)
        {
          data.email = user_data.email
          var date = new Date()
          date.setMonth(date.getMonth() + 1)
          document.cookie = "sbtghuser=" + data.uname +
            ";domain=" + document.domain + ';expires='+ date.toUTCString()
          document.cookie = "sbtghsword=" + data.upass +
            ";domain=" + document.domain + ';expires='+ date.toUTCString()
          show_userdata(data, user_data)
        },
        function(){$('#auth-failed').slideDown()})
      $('#auth-form').slideUp()
      return account
    }

    function get_authdata()
    {
      var uname = getCookie('sbtghuser')
      if (uname.length == 0)
      { return false }
      var upass = getCookie('sbtghsword')
      return {uname : uname, upass: upass}
    }

    function commit(account, editor)
    {
      refresh_worker(theStatusUpdater)
      var obj = editor.get_json()
      var translated = 0
      for (i in obj)
      {
        var field = obj[i]
        if (typeof field['Texts']['Rus'] == "string" &&
          field['Texts']['Rus'].length > 0)
        {
          translated++
        }
      }

      var content = JSON.stringify(obj, null, 2)
      if (!account.authdata.uname)
      {return}
      var messagetext = $('#commitMessageText')[0].value
      if (messagetext.length == 0)
      {messagetext = 'Обновление ' + editor.filedata.path}

      var tree = []
      tree.push(make_tree_entry(editor.filedata.path, content))
      function on_progress(progress)
      {
        $('#commitProgress')[0].style.width = progress + '%'
        $('#commitProgress')[0].setAttribute('aria-valuenow', progress)
      }
      function on_success(d, s, r)
      {
        editor.touched = false
        editor.filedata.content = Base64.encode(
          JSON.stringify(editor.get_json(), null, 2))
        $('#commitWait').slideUp()
        $('#commitMessageText')[0].value = ""
        $('#commitSuccess').slideDown().delay(2000).slideUp()
        theStatusUpdater.worker.postMessage({
            name: "getstatus",
            path: editor.filedata.path,
            id: "progress-" + editor.filedata.name
          })
      }
      function on_fail(d, status, errorThrown)
      {
        $('#commitWait').slideUp()
        console.log(JSON.stringify(d, null, 2))
        console.log(status)
        console.log(errorThrown)
        $('#commitFailedText')[0].innerHTML = "<strong>Ошибка!</strong> При попытке " +
          "сохранения изменений произошла ошибка: " +
          (errorThrown ? errorThrown: "неизвестная ошибка" ) + " статус: " +
          (status ? status: "неизвестен" ) + ". Дополнительная информация:\n" +
          JSON.stringify(d, null, 2)
        $('#commitFailed').slideDown().delay(10000).slideUp()
      }
      var callback_index = add_event_callback(theStatusUpdater, "updatetranslated",
      function(data)
      {
        if (data.needed)
        {
          tree.push(make_tree_entry("translations/translatedlabels.json", JSON.stringify(data.json, null, 2)))
        }
        $('#commitProgress')[0].style.width = '0%'
        $('#commitWait').slideDown()
        account.do_commit(messagetext, tree, on_fail, on_success, on_progress)
        remove_event_callback(theStatusUpdater, callback_index)
      })
      theStatusUpdater.promise.then(function(w)
      {
        w.postMessage(
          {name: "updatetranslated", value: translated, path: editor.filedata.path})
      })
    }

    function statusUpdateHandler(data)
    {
      var obj = document.getElementById(data.id)
      obj.style.width = data.val + '%'
      obj.setAttribute('aria-valuenow', data.val)
      obj.innerHTML = Math.floor(data.val) + '% переведено'
      if (data.val < 50)
      {
        obj.className = 'progress-bar progress-bar-danger'
      }
      else if (data.val < 100)
      {
        obj.className = 'progress-bar progress-bar-warning'
      }
    }
  </script>
</head>
<body>
  <div class='wrapper container'>
  <header style='height: 100px' class='container'>
    <div class='row'>
    <div class='col-sm-6'>
    <h1>Интерфейс переводчика</h1>
     <div class="progress">
        <div class="progress-bar" role="progressbar" id='global-progress'
        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
          <span>0% переведено</span>
        </div>
      </div>
    </div>
    </div>
  </header>

  <nav id='topnav' class='navbar navbar-default' data-spy='affix' data-offset-top='101'>
  <div class='container' style='float:left'>
    <div class='col-sm-3'>
    <h3 id='current-filename'></h3>
    </div>
    <ul id='editor-navigator' class='pagination'></ul>
  </div>
  </nav>

  <div class='row container-fluid'>
  <aside class='col-sm-2' >
  <nav id='sidebar' class='navbar-default' data-spy='affix'
    data-offset-top='97'>
  <div id="fmnavigation">
    <button class="btn btn-default" id="login-button" style="display:none"
      type="button">Войти</button>
  </div>
  <div id="editor-navigation"  style="display: none">
    <button class="btn btn-default" onclick='$("#loginRequiredAlert").slideDown()'
    type="button" id='commitButton'>Сохранить</button>
    <button class="btn btn-default" id='backtofm' type="button">Назад</button>
    <button class="btn btn-default"
    onclick="$('#editor-holder div[data-schemapath=root]').children('h3')
    .find('button.json-editor-btn-collapse').click();"
    type="button">
      [Раз/С]вернуть всё</button>
  </div>
  <button class="btn btn-default" id='gohome'
      type="button">Домой</button>
  <button class="btn btn-default"
      onclick="$('html, body').stop().animate({scrollTop: 0}, 1000)"
      type="button">Наверх</button>
  <div id='authorized' style='display: none'></div>
  <div id='auth-failed' style='display: none'>Авторизация не удалась!
  <div><button class="btn btn-default" type="button"
    onclick="$('#auth-failed').slideUp(); $('#auth-form').slideDown()">
    Попробовать снова</button></div></div>
  <form id="auth-form" style="display: none">
    Имя пользователя:
    <input type='text' class='form-control' name='uname'>
    Пароль:
    <input type='password' class='form-control' name='upass'>
    <button class="btn btn-success"
    id="do-login" type="button">Вход</button>
  </form>
  </nav>
  </aside>

  <section class='col-sm-10'><!-- content -->
  <section style='position: fixed; z-index: 3; width:50%'>
  <!-- Alerts-->
  <div class="alert alert-success fade in" id='commitSuccess'
  style='display:none;'>
  <a href='#' class="close" onclick='$("#commitSuccess").slideUp()'>&times;</a>
  <strong>Успех!</strong> Ваши изменения успешно сохранены!
  </div>
  <div class="alert alert-info" id='commitWait'
  style='display:none'>
  <p>Пожалуйста, подождите, идет сохранение...</p>
  <div class="progress">
    <div class="progress-bar bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
      style='width: 0%' id='commitProgress'>
    </div>
  </div>
  </div>
  <div class="alert alert-danger fade in" id='commitFailed'
  style='display:none;'>
  <a href='#' class="close" onclick='$("#commitFailed").slideUp()'>&times;</a>
  <p id='commitFailedText'></p>
  </div>
  <div class="alert alert-danger fade in" id='loginRequiredAlert'
  style='display:none;'>
  <a href='#' class="close" onclick='$("#loginRequiredAlert").slideUp()'>&times;</a>
  <strong>Ошибка!</strong> Чтобы сохранить изменения нужно войти.
  </div>
  <!-- /Alerts-->
  </section>

  <section>
  <div id="file-browser">
  </div>
  <div id="editor-holder" style="display: none">
  <div id='editor-holder-body'></div>
  </div>
  </section>

  </section><!-- /content-->
  </div><!-- /content row -->
  </div><!-- /wrapper -->

  <!--Commit modal -->
  <div id='commitMessage' class='modal fade' role='dialog'>
  <div class='modal-dialog modal-lg'>
  <div class='modal-content'>
  <div class='modal-header'>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <h4 class="modal-title">Комментарий к изменениям</h4>
  </div>
  <div class='modal-body'>
    Введите комментарий с кратким описанием внесенных изменений, а также, возможно,
    основаниями для принятых решений. Данный комментарий будет сохранен в истории
    изменений.
    <textarea class='form-control input-lg' id='commitMessageText' rows='8'></textarea>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-success" id='perform-commit'
    data-dismiss="modal">
    Сохранить</button>
    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
  </div>
  </div>
  </div>
  </div><!--/Commit modal -->

  <!--Unsaved modal -->
  <div id='unsavedMessage' class='modal fade' role='dialog'>
  <div class='modal-dialog modal-lg'>
  <div class='modal-content'>
  <div class='modal-header'>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <h4 class="modal-title">Остались несохраненные изменения</h4>
  </div>
  <div class='modal-body'>
    На странице остались несохраненные изменения! Вы точно хотите отбросить их и
    вернуться к списку файлов?
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-success" data-dismiss="modal"
    onclick="$('#commitButton').click(); $('#backtofm').click()">
    Сохранить изменения</button>
    <button type="button" class="btn btn-warning" id='force-backtofm'
    data-dismiss="modal">
    Отбросить изменения</button>
    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
  </div>
  </div>
  </div>
  </div><!--/Unsaved modal -->

  <script type="text/javascript">
    var theStatusUpdater = {}
    $(document).ready(function()
    {
      // Initialization
      var editor = new theEditor("editor-holder-body", "editor-navigator")

      function on_file(json)
      {
        $("#editor-holder").slideDown()
        $("#file-browser").slideUp()
        $("#editor-navigation").slideDown()
        $("#fmnavigation").slideUp()
        editor.filedata = json
        editor.open_json(Base64.decode(json.content))
      }

      prepare_fm(document.getElementById("file-browser"))
      var authdata = get_authdata()
      var account = new GHAccount(authdata, "SBT-community/Starbound_RU",
        'web-interface')
      if (authdata == false)
      {
        document.getElementById('auth-form').style.display = ''
      }
      else
      {
        login(account,authdata)
      }

      theStatusUpdater = get_worker(account)
      add_event_callback(theStatusUpdater, "setstatus", statusUpdateHandler)

      var args = get_call_arguments()
      if (!args.code)
      {
        var authbutton = document.getElementById("login-button")
        //authbutton.style.display = ""//Will be commented until oauth wont be implemented
        var state = Math.random().toString(36).substring(7);
        var href_part = "https://github.com/login/oauth/authorize?" +
            "client_id=9e609aef5d6e71a4ed63&" +
            "redirect_url=\\\"https://sbt-community.github.io/\\\"&" +
            "state=" + state
        authbutton.onclick = function(){
          location.href = href_part
        }
      }
      else
      {
        alert("Autorization token received but no client secret provided."+
          "It's not your fault, just a signal about forbidden type of authorization." +
          "Actually you shouldn't see that message.")
      }
      $('#perform-commit').on('click', function(){commit(account, editor)})
      $('#backtofm').on('click', function(){backtofm(editor);})
      $('#force-backtofm').on('click', function()
      {
        editor.touched = false;
        backtofm(editor);
      })
      $('#gohome').on('click', function()
      {
        backtofm(editor);
        goto_home(account, on_file)
      })
      $('#do-login').on('click', function()
      {
        login(account, $('#auth-form').serializeArray().reduce(function(o, i)
          {
            o[i.name] = i.value;
            return o;
          }, {}))
      })
      goto_home(account, on_file)
      theStatusUpdater.promise.then(function(w){ w.postMessage({name: 'getstatus',
        id: 'global-progress', path: 'translations/'})})
    })
  </script>
</body>
</html>
